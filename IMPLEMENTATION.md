# Amazon Connect CI/CD Implementation

README.mdä»•æ§˜æ›¸ã«åŸºã¥ã Amazon Connect ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ•ãƒ­ãƒ¼ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè£…ã§ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Development   â”‚    â”‚      Test       â”‚    â”‚   Production    â”‚
â”‚   Environment   â”‚    â”‚   Environment   â”‚    â”‚   Environment   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Designer  â”‚ â”‚    â”‚ â”‚ Auto Deploy â”‚ â”‚    â”‚ â”‚Blue/Green   â”‚ â”‚
â”‚ â”‚   Manual    â”‚ â”‚    â”‚ â”‚   CI/CD     â”‚ â”‚    â”‚ â”‚Deployment   â”‚ â”‚
â”‚ â”‚   Export    â”‚ â”‚    â”‚ â”‚   Testing   â”‚ â”‚    â”‚ â”‚ Approval    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Repository                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚    flows/   â”‚ â”‚    env/     â”‚ â”‚  scripts/   â”‚ â”‚   .github/  â”‚â”‚
â”‚  â”‚ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ â”‚ â”‚ ç’°å¢ƒè¨­å®š     â”‚ â”‚ å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â”‚ â”‚ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
amazon_connect_deploy/
â”œâ”€â”€ flows/                      # ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ SalesEntry/
â”‚   â”‚   â”œâ”€â”€ flow.json.tmpl     # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ modules/           # ãƒ•ãƒ­ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
â”‚   â””â”€â”€ SupportEntry/
â”‚       â””â”€â”€ flow.json.tmpl
â”œâ”€â”€ env/                       # ç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ dev.yaml              # é–‹ç™ºç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ test.yaml             # ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
â”‚   â””â”€â”€ prod.yaml             # æœ¬ç•ªç’°å¢ƒè¨­å®š
â”œâ”€â”€ scripts/                  # å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”œâ”€â”€ normalize.js          # ãƒ•ãƒ­ãƒ¼æ­£è¦åŒ–
â”‚   â”œâ”€â”€ render.js             # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
â”‚   â”œâ”€â”€ validate.js           # æ¤œè¨¼
â”‚   â””â”€â”€ ...                   # ãã®ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ cdk/                      # CDK ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ app.js               # CDKã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ connect-flow-stack.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ .github/workflows/        # GitHub Actions
â”‚   â”œâ”€â”€ pr-validation.yml     # PRæ¤œè¨¼
â”‚   â”œâ”€â”€ deploy-test.yml       # TESTç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
â”‚   â”œâ”€â”€ deploy-prod.yml       # PRODç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
â”‚   â””â”€â”€ drift-detection.yml   # ãƒ‰ãƒªãƒ•ãƒˆæ¤œå‡º
â”œâ”€â”€ tests/                    # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ dist/                     # ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœ (ç”Ÿæˆ)
```

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
cd cdk && npm install
```

### 2. ç’°å¢ƒè¨­å®š

å„ç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (`env/*.yaml`) ã‚’å®Ÿéš›ã®å€¤ã§æ›´æ–°ï¼š

```yaml
# env/dev.yaml ã®ä¾‹
connect:
  instance_id: "your-connect-instance-id"
  instance_arn: "arn:aws:connect:region:account:instance/instance-id"
  region: "us-east-1"

tokens:
  Lambda:
    AuthenticationAlias: "arn:aws:lambda:region:account:function:auth:LIVE"
  Queue:
    Sales: "arn:aws:connect:region:account:instance/instance-id/queue/queue-id"
  # ... ãã®ä»–ã®ãƒˆãƒ¼ã‚¯ãƒ³
```

### 3. AWSèªè¨¼è¨­å®š

GitHub OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¨­å®šã—ã€å„ç’°å¢ƒç”¨ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆï¼š

```bash
# AWS CLI ã§OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com
```

### 4. GitHub Environmentsè¨­å®š

GitHub ãƒªãƒã‚¸ãƒˆãƒªã§ Environment ã‚’è¨­å®šï¼š
- `test` (è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤)
- `prod` (æ‰¿èªå¿…é ˆ)

### 5. Secrets/Variablesè¨­å®š

GitHub ãƒªãƒã‚¸ãƒˆãƒªã«ä»¥ä¸‹ã‚’è¨­å®šï¼š

**Variables:**
- `AWS_TEST_DEPLOY_ROLE_ARN`
- `AWS_PROD_DEPLOY_ROLE_ARN` 
- `AWS_TEST_DRIFT_ROLE_ARN`
- `AWS_PROD_DRIFT_ROLE_ARN`

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### é–‹ç™ºãƒ•ãƒ­ãƒ¼

1. **ãƒ•ãƒ­ãƒ¼ä½œæˆ/ç·¨é›†**
   ```bash
   # ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆãƒ»ç·¨é›†å¾Œã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   # flows/{FlowName}/flow.json.tmpl ã¨ã—ã¦ã‚³ãƒŸãƒƒãƒˆ
   ```

2. **æ­£è¦åŒ–**
   ```bash
   npm run normalize
   ```

3. **æ¤œè¨¼**
   ```bash
   npm run validate
   ```

4. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**
   ```bash
   npm run render -- --env test --output ./dist/test
   ```

### CI/CD ãƒ•ãƒ­ãƒ¼

1. **PRä½œæˆ** â†’ è‡ªå‹•æ¤œè¨¼å®Ÿè¡Œ
2. **main ãƒãƒ¼ã‚¸** â†’ TESTç’°å¢ƒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
3. **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°** â†’ PRODç’°å¢ƒæ‰¿èªå¾Œãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ä¾‹
git tag release-20251016-abc1234
git push origin release-20251016-abc1234
```

## ğŸ”§ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|------|
| `npm run normalize` | ãƒ•ãƒ­ãƒ¼JSONã‚’æ­£è¦åŒ– |
| `npm run validate` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨è¨­å®šã‚’æ¤œè¨¼ |
| `npm run render` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° |
| `npm run test` | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ |
| `npm run lint` | ã‚³ãƒ¼ãƒ‰lintå®Ÿè¡Œ |

### CDK ã‚³ãƒãƒ³ãƒ‰

```bash
cd cdk

# åˆæˆ 
cdk synth --context environment=test

# ãƒ‡ãƒ—ãƒ­ã‚¤
cdk deploy --context environment=test --context flowsPath=../dist/test

# å·®åˆ†ç¢ºèª
cdk diff --context environment=prod
```

## ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

### ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼
- `${Service.Entity[.Variant]}`
- ä¾‹: `${Lambda.InvokeAlias}`, `${Queue.Sales}`, `${Prompt.WelcomeJa}`

### å¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹
- **Lambda**: Alias ARN
- **Queue**: Connect ARN  
- **Prompt**: Connect ARN
- **Lex**: Connect ARN
- **PhoneNumber**: E.164å½¢å¼

### ä½¿ç”¨ä¾‹

```json
{
  "LambdaFunctionARN": "${Lambda.AuthenticationAlias}",
  "QueueId": "${Queue.Sales}",
  "PromptId": "${Prompt.WelcomeJa}",
  "PhoneNumber": "${PhoneNumber.Main}"
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

```bash
# ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
npm test -- --coverage

# ç‰¹å®šãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
npm test tests/integration.test.js
```

## ğŸ“Š ç›£è¦–ãƒ»é‹ç”¨

### ãƒ‰ãƒªãƒ•ãƒˆæ¤œå‡º
- æ¯å¤œ23:00 JST ã«è‡ªå‹•å®Ÿè¡Œ
- Connect APIã‹ã‚‰ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã—ã€æœŸå¾…å€¤ã¨æ¯”è¼ƒ
- å·®åˆ†ãŒã‚ã‚Œã°GitHub Issueã‚’è‡ªå‹•ä½œæˆ

### Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤
1. æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆ
2. ã‚«ãƒŠãƒªã‚¢ç•ªå·ã§å°è¦æ¨¡ãƒ†ã‚¹ãƒˆ (5%)
3. æ®µéšçš„ã«æ‹¡å¤§ (20% â†’ 50% â†’ 100%)
4. å•é¡ŒãŒã‚ã‚Œã°å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

### ãƒ­ã‚°ãƒ»ç›£è¦–
- CloudWatch Logs: `/aws/connect/{env}`
- ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹: `Connect/{Env}` namespace
- ã‚¢ãƒ©ãƒ¼ãƒˆ: SNSãƒˆãƒ”ãƒƒã‚¯çµŒç”±

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ãƒˆãƒ¼ã‚¯ãƒ³æœªè§£æ±ºã‚¨ãƒ©ãƒ¼**
   ```
   Token not found: Lambda.NonExistentAlias
   ```
   â†’ `env/{environment}.yaml` ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **ARNå½¢å¼ã‚¨ãƒ©ãƒ¼**
   ```
   Invalid ARN format: invalid-arn
   ```
   â†’ ARNã®å½¢å¼ã¨å¯¾è±¡ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª

3. **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDä¸ä¸€è‡´**
   ```
   Instance ID mismatch in Connect ARN
   ```
   â†’ Connect ARNå†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒè¨­å®šã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª

4. **CDKãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼**
   ```
   Access denied for Connect operations
   ```
   â†’ IAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã¨AssumeRoleè¨­å®šã‚’ç¢ºèª

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ (å…¥å£ã‚’æ—§ç‰ˆã«æˆ»ã™)
node scripts/blue-green-controller.js --env prod --action rollback

# è¨­å®šã‚’Gitã®å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
git revert <commit-hash>
git push origin main  # TESTç’°å¢ƒã«è‡ªå‹•é©ç”¨
```

## ğŸ“š å‚è€ƒè³‡æ–™

- [README.mdä»•æ§˜æ›¸](./README.md) - è©³ç´°ãªè¦ä»¶ã¨è¨­è¨ˆ
- [Amazon Connect API Reference](https://docs.aws.amazon.com/connect/latest/APIReference/)
- [AWS CDK Developer Guide](https://docs.aws.amazon.com/cdk/)
- [GitHub Actions Documentation](https://docs.github.com/actions)

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. ãƒ•ãƒ­ãƒ¼ã®å¤‰æ›´ã¯ã¾ãšé–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
2. PRä½œæˆå‰ã« `npm run validate` ã¨ `npm test` ã‚’å®Ÿè¡Œ  
3. æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ã¯æ…é‡ã«æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã‚’çµŒã‚‹
4. å•é¡Œç™ºç”Ÿæ™‚ã¯å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ãªçŠ¶æ…‹ã‚’ä¿ã¤

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

- æŠ€è¡“çš„ãªå•é¡Œ: [GitHub Issues](https://github.com/your-org/amazon_connect_deploy/issues)
- ç·Šæ€¥æ™‚å¯¾å¿œ: ç¤¾å†…ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †ã«å¾“ã†
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã”ææ¡ˆãã ã•ã„