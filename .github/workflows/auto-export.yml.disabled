name: Auto Export Contact Flows

on:
  schedule:
    # æ¯æ—¥ JST 8:00 (UTC 23:00) ã«å®Ÿè¡Œ
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to export from'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - all
      incremental:
        description: 'Incremental export (only changed flows)'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  auto-export:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Export Contact Flows
        id: export
        run: |
          # ç’°å¢ƒå¤‰æ•°è¨­å®š
          export CONNECT_INSTANCE_ID_DEV="${{ vars.CONNECT_INSTANCE_ID_DEV }}"
          export CONNECT_INSTANCE_ID_TEST="${{ vars.CONNECT_INSTANCE_ID_TEST }}"
          
          # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
          if [ "${{ github.event.inputs.environment || 'dev' }}" = "all" ]; then
            echo "Exporting all environments..."
            npm run export:auto
          else
            ENV="${{ github.event.inputs.environment || 'dev' }}"
            INSTANCE_VAR="CONNECT_INSTANCE_ID_${ENV^^}"
            INSTANCE_ID="${!INSTANCE_VAR}"
            
            echo "Exporting from environment: $ENV"
            echo "Instance ID: $INSTANCE_ID"
            
            if [ "${{ github.event.inputs.incremental }}" = "true" ]; then
              node scripts/export.js export \
                --instance-id "$INSTANCE_ID" \
                --output "flows-$ENV" \
                --incremental
            else
              node scripts/export.js export \
                --instance-id "$INSTANCE_ID" \
                --output "flows-$ENV"
            fi
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --porcelain
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            auto: Contact Flowsè‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ›´æ–°
            
            ç’°å¢ƒ: ${{ github.event.inputs.environment || 'dev' }}
            å¢—åˆ†: ${{ github.event.inputs.incremental || 'true' }}
            å®Ÿè¡Œæ—¥æ™‚: ${{ github.run_id }}
          title: "[AUTO] Contact Flows Export - ${{ github.event.inputs.environment || 'dev' }}"
          body: |
            ## ğŸ¤– è‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

            **ç’°å¢ƒ**: `${{ github.event.inputs.environment || 'dev' }}`
            **å¢—åˆ†ãƒ¢ãƒ¼ãƒ‰**: `${{ github.event.inputs.incremental || 'true' }}`
            **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### å¤‰æ›´å†…å®¹
            Amazon Connect ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‹ã‚‰è‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸContact Flowsã®æ›´æ–°ã§ã™ã€‚

            ### ç¢ºèªé …ç›®
            - [ ] æ–°è¦ãƒ•ãƒ­ãƒ¼ã®å†…å®¹ç¢ºèª
            - [ ] æ—¢å­˜ãƒ•ãƒ­ãƒ¼ã®å¤‰æ›´å†…å®¹ç¢ºèª  
            - [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ç¢ºèª
            - [ ] ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®æ•´åˆæ€§ç¢ºèª

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
            2. å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
            3. ãƒãƒ¼ã‚¸å¾Œã€TESTç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

            ---
            *ã“ã®Pull Requestã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
          branch: auto-export/${{ github.event.inputs.environment || 'dev' }}-${{ github.run_number }}
          delete-branch: true
          labels: |
            auto-export
            contact-flows
            ${{ github.event.inputs.environment || 'dev' }}

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#connect-updates'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            Auto Export completed for `${{ github.event.inputs.environment || 'dev' }}` environment
            Changes: ${{ steps.changes.outputs.has_changes }}
            Status: ${{ job.status }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}